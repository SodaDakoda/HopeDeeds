<script>
  document.addEventListener("DOMContentLoaded", () => {
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get("email");

    const welcomeMessage = document.getElementById("welcome-message");
    const orgNameEl = document.getElementById("data-org-name");
    const emailEl = document.getElementById("data-email");
    const phoneEl = document.getElementById("data-phone");
    const addressEl = document.getElementById("data-address");
    const opportunitiesList = document.getElementById("org-opportunities-list");
    const dataOpportunitiesEl = document.getElementById("data-opportunities");

    if (!email) {
      welcomeMessage.textContent = "Welcome! Please log in to view your dashboard.";
      return;
    }

    // --------------------- Fetch Organization Data ---------------------
    const fetchOrgData = async () => {
      try {
        const res = await fetch(`/api/organization/${encodeURIComponent(email)}`);
        if (!res.ok) throw new Error("Organization not found");

        const org = await res.json();

        // Update profile info
        welcomeMessage.textContent = `Welcome Back, ${org.org_name.split(" ")[0]}!`;
        orgNameEl.textContent = org.org_name || "N/A";
        emailEl.textContent = org.email || "N/A";
        phoneEl.textContent = org.phone || "N/A";
        addressEl.textContent = org.address || "N/A";

        // Clear and show default message for opportunities until API exists
        opportunitiesList.innerHTML = "<li>No opportunities posted yet.</li>";
        dataOpportunitiesEl.textContent = 0;

        // If you later add `/api/org/:email/opportunities`, uncomment:

        const oppRes = await fetch(`/api/org/${encodeURIComponent(email)}/opportunities`);
        if (oppRes.ok) {
          const opportunities = await oppRes.json();
          opportunitiesList.innerHTML = "";
          if (opportunities.length > 0) {
            opportunities.forEach((opp) => {
              const li = document.createElement("li");
              li.textContent = `${opp.title} - ${opp.date} (${opp.time})`;
              opportunitiesList.appendChild(li);
            });
            dataOpportunitiesEl.textContent = opportunities.length;
          }
        }
        */
      } catch (err) {
        console.error("Error loading organization:", err);
        welcomeMessage.textContent = "Error loading dashboard.";
      }
    };

    fetchOrgData();

    // --------------------- Handle New Opportunity Submission ---------------------
    const form = document.getElementById("new-opportunity-form");
    if (form) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const title = document.getElementById("opportunity-title").value.trim();
        const date = document.getElementById("opportunity-date").value;
        const time = document.getElementById("opportunity-time").value;
        const description = document.getElementById("opportunity-description").value.trim();

        if (!title || !date || !time || !description) {
          alert("Please fill in all fields.");
          return;
        }

        // Temporarily alert until API exists
        alert("Opportunity added! (API endpoint not yet implemented.)");

        // Clear form
        form.reset();

        // Refresh dashboard
        fetchOrgData();
      });
    }
  });
</script>
