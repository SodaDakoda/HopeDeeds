<script>
  document.addEventListener("DOMContentLoaded", () => {
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get("email");

    if (!email) {
      document.getElementById("welcome-message").textContent =
        "Welcome! Please log in to view your dashboard.";
      return;
    }

    // --------------------- Helper ---------------------
    const fetchOrgData = async () => {
      try {
        const res = await fetch(
          `/api/organization/${encodeURIComponent(email)}`
        );
        if (!res.ok) throw new Error("Organization not found");
        const org = await res.json();

        // Update profile info
        document.getElementById(
          "welcome-message"
        ).textContent = `Welcome Back, ${org.org_name.split(" ")[0]}!`;
        document.getElementById("data-org-name").textContent = org.org_name;
        document.getElementById("data-email").textContent = org.email;
        document.getElementById("data-phone").textContent = org.phone || "N/A";
        document.getElementById("data-address").textContent =
          org.address || "N/A";

        // Fetch opportunities posted by this org
        const oppRes = await fetch(
          `/api/org/${encodeURIComponent(email)}/opportunities`
        );
        let opportunities = [];
        if (oppRes.ok) opportunities = await oppRes.json();

        const opportunitiesList = document.getElementById(
          "org-opportunities-list"
        );
        opportunitiesList.innerHTML = "";
        if (opportunities.length > 0) {
          opportunities.forEach((opp) => {
            const li = document.createElement("li");
            li.textContent = `${opp.title} - ${opp.date} (${opp.time})`;
            opportunitiesList.appendChild(li);
          });
        } else {
          opportunitiesList.innerHTML = "<li>No opportunities posted yet.</li>";
        }

        document.getElementById("data-opportunities").textContent =
          opportunities.length;
      } catch (err) {
        console.error("Error loading organization:", err);
        document.getElementById("welcome-message").textContent =
          "Error loading dashboard.";
      }
    };

    fetchOrgData();

    // --------------------- Add New Opportunity ---------------------
    const form = document.getElementById("new-opportunity-form");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const title = document.getElementById("opportunity-title").value.trim();
      const date = document.getElementById("opportunity-date").value;
      const time = document.getElementById("opportunity-time").value;
      const description = document
        .getElementById("opportunity-description")
        .value.trim();

      if (!title || !date || !time || !description) {
        alert("Please fill in all fields.");
        return;
      }

      try {
        const res = await fetch(
          `/api/org/${encodeURIComponent(email)}/opportunities`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, date, time, description }),
          }
        );
        if (!res.ok) throw new Error("Failed to add opportunity");

        // Clear form
        form.reset();

        // Refresh dashboard list
        fetchOrgData();
        alert("Opportunity added successfully!");
      } catch (err) {
        console.error(err);
        alert("Error adding opportunity. Check console for details.");
      }
    });
  });
</script>
