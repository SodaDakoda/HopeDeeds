<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Opportunity Details | HopeDeeds</title>

    <!-- Tailwind for layout utilities only -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />

    <!-- Your site theme (colors, buttons, cards, etc.) -->
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <!-- Header that matches your theme -->
    <header>
      <div class="container">
        <nav>
          <div class="logo">Hope<span>Deeds</span></div>
          <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="opportunities.html">Opportunities</a></li>
            <li><a href="organization_dashboard.html">Dashboard</a></li>
            <li><a href="/org/logout" class="btn btn-secondary">Log Out</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <main>
      <div class="container" style="padding: 40px 0">
        <a
          href="organization_dashboard.html"
          class="btn button"
          style="margin-bottom: 16px"
        >
          <i class="fas fa-arrow-left"></i>&nbsp; Back
        </a>

        <!-- Details card -->
        <section class="dashboard-section" style="margin-bottom: 24px">
          <h2>
            <i class="fas fa-calendar-alt"></i>
            <span id="opp-title">Loading...</span>
          </h2>
          <p id="opp-description" class="text-muted" style="margin-top: 6px">
            Loading opportunity description…
          </p>

          <div
            id="opp-info"
            class="grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
              gap: 12px;
              margin-top: 14px;
            "
          ></div>

          <div
            style="margin-top: 16px; display: flex; gap: 10px; flex-wrap: wrap"
          >
            <a id="edit-link" class="btn btn-primary button" href="#">
              <i class="fas fa-edit"></i>&nbsp; Edit Opportunity
            </a>
            <button
              id="deactivate-btn"
              class="btn btn-secondary button"
              type="button"
            >
              <i class="fas fa-ban"></i>&nbsp; Mark as Filled / Inactive
            </button>
          </div>
        </section>

        <!-- Volunteers list card -->
        <section class="dashboard-section">
          <h2><i class="fas fa-users"></i> Volunteers Signed Up</h2>
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="volunteer-table-body">
              <tr>
                <td colspan="4">Loading volunteers…</td>
              </tr>
            </tbody>
          </table>
        </section>
      </div>
    </main>

    <footer>
      <div class="container footer-content">
        <div class="footer-section">
          <h4>HopeDeeds</h4>
          <p>&copy; 2025 Volunteer Management Platform.</p>
        </div>
        <div class="footer-section">
          <h4>Contact</h4>
          <p>Email: info@hopedeeds.org</p>
        </div>
        <div class="footer-section">
          <h4>Connect</h4>
          <ul class="social-links">
            <li>
              <a href="#"><i class="fab fa-facebook-f"></i></a>
            </li>
            <li>
              <a href="#"><i class="fab fa-twitter"></i></a>
            </li>
            <li>
              <a href="#"><i class="fab fa-instagram"></i></a>
            </li>
          </ul>
        </div>
      </div>
    </footer>

    <script>
      // ---------- Small helpers ----------
      function safe(val, fallback) {
        return val !== null && val !== undefined && val !== ""
          ? val
          : fallback || "N/A";
      }
      function fmtDate(d) {
        if (!d) return "N/A";
        const dt = new Date(d);
        return isNaN(dt) ? d : dt.toLocaleDateString();
      }
      function fmtTime(t) {
        // We expect "HH:MM" or "HH:MM:SS" from Postgres TIME
        if (!t) return "TBD";
        const parts = String(t).split(":");
        if (parts.length >= 2) {
          const hh = parts[0].padStart(2, "0");
          const mm = parts[1].padStart(2, "0");
          return hh + ":" + mm;
        }
        return t;
      }
      function setDeactivateHandler(id) {
        var btn = document.getElementById("deactivate-btn");
        if (!btn) return;
        btn.addEventListener("click", async function () {
          var ok = confirm("Mark this opportunity as filled/inactive?");
          if (!ok) return;

          // NOTE: This PUT expects your server to accept partial updates (status only).
          // If your current PUT requires all fields, we should switch to a dedicated status endpoint.
          try {
            const res = await fetch("/api/opportunities/" + id, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ status: "canceled" }),
            });
            if (res.ok) {
              alert("Opportunity updated.");
              window.location.href = "organization_dashboard.html";
            } else {
              alert("Failed to update opportunity.");
            }
          } catch (e) {
            console.error(e);
            alert("Failed to update opportunity.");
          }
        });
      }

      async function loadOpportunity() {
        var params = new URLSearchParams(window.location.search);
        var id = params.get("id");
        var infoDiv = document.getElementById("opp-info");
        var volTbody = document.getElementById("volunteer-table-body");
        var editLink = document.getElementById("edit-link");

        if (!id) {
          infoDiv.innerHTML =
            "<p style='color: var(--danger);'>Missing opportunity id.</p>";
          return;
        }

        // Set edit link immediately
        editLink.setAttribute("href", "edit_opportunity.html?id=" + id);

        try {
          const res = await fetch("/api/opportunities/" + id);
          if (!res.ok) throw new Error("Failed to load opportunity");
          const opp = await res.json();

          document.getElementById("opp-title").textContent = safe(opp.title);
          document.getElementById("opp-description").textContent = safe(
            opp.description,
            "No description provided."
          );

          // Build the info grid safely without nested template strings
          var pieces = [];
          pieces.push(
            "<p><strong>Date:</strong> " + fmtDate(opp.start_date) + "</p>"
          );

          var timeLabel =
            "<p><strong>Time:</strong> " + fmtTime(opp.start_time);
          if (opp.end_time) timeLabel += " - " + fmtTime(opp.end_time);
          timeLabel += "</p>";
          pieces.push(timeLabel);

          pieces.push(
            "<p><strong>Area:</strong> " + safe(opp.area, "General") + "</p>"
          );
          pieces.push(
            "<p><strong>Duration:</strong> " +
              safe(opp.duration, "Unknown") +
              " hrs</p>"
          );
          pieces.push(
            "<p><strong>Capacity:</strong> " +
              safe(opp.max_capacity, "Unlimited") +
              "</p>"
          );
          pieces.push(
            "<p><strong>Frequency:</strong> " +
              safe(opp.frequency_type, "One-time") +
              "</p>"
          );
          pieces.push(
            "<p><strong>Recurs Until:</strong> " +
              fmtDate(opp.recur_until) +
              "</p>"
          );
          pieces.push(
            "<p><strong>Special:</strong> " +
              safe(opp.special_type, "None") +
              "</p>"
          );

          infoDiv.innerHTML = pieces.join("");

          // Volunteers
          var volunteers = Array.isArray(opp.volunteers) ? opp.volunteers : [];
          volTbody.innerHTML = "";
          if (!volunteers.length) {
            volTbody.innerHTML =
              "<tr><td colspan='4' style='text-align:center;color:gray;'>No volunteers signed up yet.</td></tr>";
          } else {
            // Build rows with simple string concat to avoid template pitfalls
            var rows = "";
            for (var i = 0; i < volunteers.length; i++) {
              var v = volunteers[i];
              rows +=
                "<tr>" +
                "<td>" +
                safe(v.full_name) +
                "</td>" +
                "<td>" +
                safe(v.email, "-") +
                "</td>" +
                "<td>" +
                safe(v.phone, "-") +
                "</td>" +
                "<td>" +
                safe(v.status, "Confirmed") +
                "</td>" +
                "</tr>";
            }
            volTbody.innerHTML = rows;
          }

          setDeactivateHandler(id);
        } catch (err) {
          console.error(err);
          infoDiv.innerHTML =
            "<p style='color:red;'>Error loading opportunity details.</p>";
        }
      }

      document.addEventListener("DOMContentLoaded", loadOpportunity);
    </script>
  </body>
</html>
